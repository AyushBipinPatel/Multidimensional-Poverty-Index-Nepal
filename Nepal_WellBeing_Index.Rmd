---
title: "Well Being Index"
author: "Ayush Patel"
date: "`r Sys.Date()`"
output: 
  html_document: 
    css: STATAcode.css
    number_sections: yes
    theme: flatly
    toc: yes
    toc_depth: 4
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css ,echo = FALSE}
h1, h2, h3 {
  text-align: center;
  color: #303960;
}
```

__Nepal Well Being Index __

MICS 2014 data is used to create this Index. Through out this document a convention is maintained where the STATA code will be provided as reference to the equivalent  R code.

The STATA code provided as referecne will show up as follows[^1]:

:::statacode
Reference STATA code will appear in such boxes.
:::

[^1]: Icons made by <a href="https://www.flaticon.com/authors/xnimrodx" title="xnimrodx">xnimrodx</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a>

# Libraries

```{r libraries}
library(here)
library(tidyverse)
library(haven)
library(janitor)
library(magrittr)
library(knitr)
library(kableExtra)
library(gt)
library(anthro)
```

# Step1: Data Preparation

Comment from STATA code:

_Selecting main variables from WM and CH recode and merging with HL recode._  

## Step1.1: CH - Children's Level (Children Under 5)


:::statacode
use "$workingfolder_in\ch.dta", clear //Change to the corresponding CH-file// 
:::

Note that the STATA code imports the .dta file, we have the same data in .sav format. We will be using these files.

```{r dataimport_ch}
ch_dta <- read_sav(here("data","ch.sav"))

```

### Step1.1a: Key variable for merging


:::statacode
rename _all, lower 
:::

```{r}
ch_dta <- clean_names(ch_dta)
```

:::statacode
gen double ind_id = hh1*100000 + hh2*100 + ln 

//Please check length of variables for a correct generation of the id variable// 

format ind_id %20.0g 

label var ind_id "Individual ID" 
:::

```{r Indid_ch}
ch_dta %<>%
  mutate(
    ind_id = structure(
      hh1*100000 + hh2*100 + ln,
      label = "Individual ID"
    )
  )
```


:::statacode
duplicates report ind_id 

duplicates tag ind_id, gen(duplicates) 

tab ln if duplicates!=0 //A number of children are not listed in the household// 
:::

```{r ch_duplicate_ind_id}
(nrow(ch_dta) == length(unique(ch_dta$ind_id)) 
 & sum(is.na(ch_dta$ind_id)) == 0) ## Returns on True if ind_id has no duplicates

# creating a table of ind_ids that are duplicatess
table(ch_dta$ind_id) %>% 
  as.data.frame %>% 
  filter(Freq>1) -> ch_dta_duplicate_ind_id

ch_dta %<>%
  mutate(
    duplicates = ind_id  %in% ch_dta_duplicate_ind_id$Var1
  ) 

ch_dta %>%
  filter(duplicates == 1) %>% 
  tabyl(ln, show_na = T)
```

:::statacode
bys ind_id: gen line = (_n) 

replace ind_id =  hh1*100000 + hh2*190 + line if duplicate!=0 //We assume consecutive hh line starting at 90// 
 
duplicates report ind_id //We should not have any duplicate at this stage// 
 
gen child_CH = 1 //Identification variable for observations in CH recode// 
:::

```{r removing_duplicates_if_any}
ch_dta %<>%
  group_by(ind_id) %>% 
  mutate(line = n()) %>% 
  ungroup()
  
ch_dta %<>% 
  mutate(
    ind_id = structure(
      ifelse(duplicates != 0,
             hh1*100000 + hh2*190 + line, ind_id),
      label = "Individual ID"
    ),
    child_CH = 1
  )

(nrow(ch_dta) == length(unique(ch_dta$ind_id)) 
 & sum(is.na(ch_dta$ind_id)) == 0) ## Returns on True if ind_id has no duplicates
```

### Step 1.1b: Children Nutrition


__Variable Sex__

:::statacode
tab hl4, miss //Check the variable for "sex" has "1" for male, "2" for female and all missing values are "."// 

gen gender = hl4 

desc gender 

tab gender 

label define gender 1"male" 2"female", replace 

label values gender gender 
:::


```{r variable_sex_nutrition}
str(ch_dta$hl4)

ch_dta %<>%
  mutate(
    gender = structure(
      hl4,
      labels = c("male"  = 1, "female" = 2) 
    )
  )

str(ch_dta$gender)
```

__Variable Age__

:::statacode
ta cage,m //Check all missing values are "."// 

ta caged,m //Check all missing values are "."// 

codebook cage caged //Check unit of measure – in this case age is measured in months// 

clonevar age_months = cage  

clonevar age_days = caged 

replace age_months = . if cage==99 //No missing data here// 

gen str6 ageunit = "days" //We define the unit of measure, in this case age is measured in months, otherwise please change to ageunit = "days"// 
lab var ageunit "Days" 
:::


```{r variable_age_nutrition}
sum(is.na(ch_dta$cage))

sum(is.na(ch_dta$caged))

ch_dta %<>%
  mutate(
    age_months = ifelse(cage==99, NA, cage),
    age_days = caged,
    ageunit = structure("days", label = "Days")
  )
```

__Variable body weight[^2]__

[^2]: It must be in kilograms

:::statacode
ta an3, miss //Check all missing values are "."//  

codebook an3 //Check unit of measure – in this case weight is measured in kilograms// 

clonevar weight = an3  

desc weight  

replace weight = .  if an3>=99 //All missing values or out of range are replaced as "."// 

tab an2 an3 if an3>=99 | an3==., miss //an2: result of the measurement// summ weight 
:::

```{r variable_bodyweight_nutrition}
sum(is.na(ch_dta$an3))

str(ch_dta$an3)

ch_dta %<>%
  mutate(
    weight = ifelse(an3 >=99, NA, an3)
  )

ch_dta %>% 
  filter(an3 >=99 | is.na(an3)) %>% 
  tabyl(an2, an3,show_na = T) %>%
  knitr::kable()%>%
  kableExtra::kable_styling()
  
  
  
  
  
```


__Variable height[^3]__

[^3]: It mus be in centimeters

:::statacode
ta an4, miss //Check all missing values are "."//  

codebook an4 //Check unit of measure – in this case age is measured in centimetres// 

clonevar height = an4 

desc height  

replace height = . if an4>=999 //All missing values or out of range are replaced as "."// 

summ height ## Not sure what this command means

codebook an4a gen measure = "l" if an4a==1 //Child measured lying down// 
replace measure = "h" if an4a==2 //Child measured standing up// 

replace measure = " " if an4a==. // No information  

replace measure = " " if an4a==9 //Replace with " " if unknown or missing//

:::


```{r varible_height_nutrition}
sum(is.na(ch_dta$an4))

str(ch_dta$an4)

ch_dta %<>%
  mutate(
    height = ifelse(an4 >= 999, NA, an4),
    measure = case_when(
      is.na(an4a) ~ NA_character_,#Notice the deviation from the stata script
      an4a == 9 ~ NA_character_,#Notice the deviation from the stata script
      an4a == 1 ~ "l",
      an4a == 2 ~ "h"
    )
  )
```

__The above mentioned deviation of using `NA` instead of " " is delibrate and retrospective. The `anthro_zscores()` does not take any other values that `"l" | "L" | "H" | "h" | NA` for the `measure` argument.__

:::statacode
tab an2 an4 if an4>=999 | an4==., miss  

tab measure,m 

:::

```{r tabs_height_variables}

ch_dta %>% 
  filter(an4 >= 999 | is.na(an4)) %>% 
  tabyl(an2, an4, show_na = T)%>%
  knitr::kable()%>%
  kableExtra::kable_styling()
  
ch_dta %>% 
  tabyl(measure, show_na = T) %>%
  knitr::kable()%>%
  kableExtra::kable_styling()

```

__Variable Oedema__


:::statacode
gen str1 oedema = "n"  

*replace oedema = "y" if an5==1 

*replace oedema = " " if an5==3 | an5==7 | an5==9 | an5==. 

desc oedema
:::


Just got to learn from Dr C. Oldiges that * is the R equivalent of #

```{r variable_oedema}
ch_dta %<>%
  mutate(
    oedema = "n"
  )

```

__Variable Smpling weight__

:::statacode
clonevar  sw = chweight 
:::

```{r varible_samplingweight}
ch_dta %<>%
  mutate(
    sw = chweight
  )
```


__Using the `{anthro}` package: equivalent ot running the ado file__


```{r}
pmap(list(sex = ch_dta$gender,
  age = ch_dta$age_days,
  is_age_in_month = FALSE,
  weight = ch_dta$weight,
  lenhei = ch_dta$height,
  measure = ch_dta$measure,
  oedema = ch_dta$oedema),
  anthro_zscores) -> test

reduce(test,rbind) -> test

head(test)

names(test)
```

__Notice the deviations from stata file, there is no need to use the `ageunit` variable as the `anthro_zscores()` function has an argument,`is_age_in_month`, that takes a logical for age unit. Secondly, there is no provision for an argument in the `anthro_zscores()` for the `sw` variable, hence I have not useed it.__

Now binding the `test` object to the `ch_dta` object.

```{r}
bind_cols(ch_dta, test) -> ch_dta
```

:::statacode
gen z_scorewa = _zwei 

replace z_scorewa = . if _fwei==1  

lab var z_scorewa "z-score weight-for-age WHO" 
:::


```{r zscorewa_nutrition}
ch_dta %<>%
  mutate(
    z_scorewa = structure(
      ifelse(fwei == 1, NA, zwei),
      label = "z-score weight-for-age WHO")
    )
```


:::statacode
gen underwa2 = (z_scorewa < -2.0) //Takes value 1 if the child is under 2 stdev below the median and 0 otherwise// 

replace underwa2 = . if z_scorewa==. 

lab var underwa2  "Child is undernourished (weight-for-age) 2sd - WHO"
:::

```{r underweight_nutrition}
ch_dta %<>%
  mutate(
    underwa2 = structure(
      ifelse(
        is.na(z_scorewa),
        NA,
        z_scorewa < -2.0
      ),
      label = "Child is undernourished (weight-for-age) 2sd-WHO"
    )
  )
```

:::statacode
gen underwa3 = (z_scorewa < -3.0) //Takes value 1 if the child is under 3 stdev below the median and 0 otherwise// 

replace underwa3 = . if z_scorewa==. 

lab var underwa3  "Child is undernourished (weight-for-age) 3sd - WHO" 
:::

```{r ultrapoverty_nutrition}
ch_dta %<>%
  mutate(
    underwa3 = structure(
      ifelse(
        is.na(z_scorewa),
        NA,
        z_scorewa < -3.0
      ),
      label = "Child is undernourished (weight-for-age) 3sd-WHO"
    )
  )
```

:::statacode
gen stunting = (_zlen < -2.0) 

replace stunting = . if _zlen == . | _flen==1 

lab var stunting "Child is undernourished (lenght/height-for-age) 2sd - WHO" 

gen stunting3 = (_zlen < -3.0) 

replace stunting3 = . if _zlen == . | _flen==1 

lab var stunting3 "Child is undernourished (lenght/height-for-age) 3sd - WHO"
:::

```{r stunting_nutrition}
ch_dta %<>%
  mutate(
    stunting = structure(
      ifelse(
        flen == 1| is.na(zlen),
        NA,
        zlen < -2.0
      ),
      label = "Chlid is undernourished (length/height-for-age 2sd-WHO)"
    ),
  stunting3 =structure(
      ifelse(
        flen == 1| is.na(zlen),
        NA,
        zlen < -3.0
      ),
      label = "Chlid is undernourished (length/height-for-age 3sd-WHO)"
    )
  )
```


:::statacode
gen wasting = (_zwfl < - 2.0) 

replace wasting = . if _zwfl == . | _fwfl == 1 

lab var wasting  "Child is undernourished (weight-for-lenght/height) 2sd - WHO" 

gen wasting3 = (_zwfl < - 3.0) 

replace wasting3 = . if _zwfl == . | _fwfl == 1 

lab var wasting3  "Child is undernourished (weight-for-lenght/height) 3sd - WHO" 
:::

```{r wasting_nutrition}
ch_dta %<>%
  mutate(
    wasting = structure(
      ifelse(
        (fwfl == 1| is.na(zwfl)),
        NA,
        zlen < -2.0
      ),
      label = "Child is undernourished (weight-for-lenght/height) 3sd - WHO"
    ),
  wasting3 =structure(
      ifelse(
        (fwfl == 1| is.na(zwfl)),
        NA,
        zlen < -3.0
      ),
      label = "Child is undernourished (weight-for-lenght/height) 3sd - WHO"
    )
  )

```

:::statacode
keep  ind_id hl4 cage hh1 hh2 ln chweight child_CH z_score* under* stun* wast* _*  

order ind_id hl4 cage hh1 hh2 ln chweight child_CH z_score* under* 
:::

```{r saving_ch}
ch_dta %>% 
  select(
    ind_id,hl4,cage,hh1,hh2,ln,chweight,
    child_CH, dplyr::starts_with("z_score"),
    dplyr::starts_with("under"),dplyr::starts_with("stun"),
    dplyr::starts_with("wast"),clenhei:fss
  ) %>% 
  write_csv(here("data","npl_CH.csv"))

```

Taking means (non weighted) of underwa, wasting and stunting for comparision.

```{r comparision_ado}
ch_dta %>% 
  summarise(
    mean_z_Scorewa = mean(z_scorewa, na.rm = T),
    mean_underwa2 = mean(underwa2, na.rm = T),
    mean_underwa3 = mean(underwa3, na.rm = T),
    mean_stunting = mean(stunting, na.rm = T),
    mean_stunting3 = mean(stunting3, na.rm = T),
    mean_wasting = mean(wasting, na.rm = T),
    mean_wasting3 = mean(wasting3, na.rm = T),
  ) %>% 
  knitr::kable()%>%
  kableExtra::kable_styling()%>%
  scroll_box(width = "100%", height = "400px")
  
  
  
  
```

